package pm.kee.vault.data

import android.content.SharedPreferences
import android.security.keystore.KeyProperties
import pm.kee.vault.util.Util.loge
import java.io.ByteArrayInputStream
import java.io.ByteArrayOutputStream
import java.io.DataOutputStream
import java.lang.Exception
import java.security.GeneralSecurityException
import java.security.SecureRandom
import javax.crypto.Cipher
import javax.crypto.SecretKey
import javax.crypto.spec.GCMParameterSpec
import javax.crypto.spec.SecretKeySpec

class KeystoreException(
        message: String? = null,
        cause: Throwable? = null
) : GeneralSecurityException(message, cause)

private const val KEYSTORE_TYPE = "AndroidKeyStore"
private const val ENCRYPTED_VERSION = 0x02

internal const val CIPHER_ALG = KeyProperties.KEY_ALGORITHM_AES
internal const val CIPHER_MOD = KeyProperties.BLOCK_MODE_GCM
internal const val CIPHER_PAD = KeyProperties.ENCRYPTION_PADDING_NONE
internal const val CIPHER_KEY_LEN = 256
internal const val CIPHER_TAG_LEN = 128
internal const val CIPHER_SPEC = "$CIPHER_ALG/$CIPHER_MOD/$CIPHER_PAD"

internal const val CIPHER_NONCE_LEN = 12

private fun applyChunkedCipher(inputArray: ByteArray, cipher: Cipher): ByteArrayOutputStream {
    val byteStream = ByteArrayOutputStream()
    val dataStream = DataOutputStream(byteStream)
    val plaintextStream = ByteArrayInputStream(inputArray)
    val chunkSize = 4 * 1024
    val buffer = ByteArray(chunkSize)
    while (plaintextStream.available() > chunkSize) {
        val readBytes = plaintextStream.read(buffer)
        val ciphertextChunk = cipher.update(buffer, 0, readBytes)
        if (ciphertextChunk != null) dataStream.write(ciphertextChunk)
    }
    val readBytes = plaintextStream.read(buffer)
    val ciphertextChunk = cipher.doFinal(buffer, 0, readBytes)
    if (ciphertextChunk != null) dataStream.write(ciphertextChunk)
    return byteStream
}

@Throws(GeneralSecurityException::class)
fun encryptBytes(plain: ByteArray, key: SecretKey): ByteArray {
    // 5116-style interface  = [ inputs || ciphertext || atag ]
    // - inputs = [ version = 0x02 || cipher.iv (always 12 bytes) ]
    // - cipher.doFinal() provides [ ciphertext || atag ]
    val cipher = createEncryptCipher(key)

    val byteStream = applyChunkedCipher(plain, cipher)

    val cdata = byteStream.toByteArray()
    val nonce = cipher.iv
    val tagLength = cipher.parameters.getParameterSpec(GCMParameterSpec::class.java).tLen
    loge("tag length: $tagLength")

    return byteArrayOf(ENCRYPTED_VERSION.toByte()) + nonce + cdata
}

@Throws(KeystoreException::class)
fun decryptBytes(encrypted: ByteArray, key: SecretKey): ByteArray {
    val version = encrypted[0].toInt()
    if (version != ENCRYPTED_VERSION) {
        throw KeystoreException("unsupported encrypted version: $version")
    }

    val iv = encrypted.sliceArray(1..CIPHER_NONCE_LEN)
    val cdata = encrypted.sliceArray((CIPHER_NONCE_LEN + 1)..encrypted.size - 1)
    val cipher = createDecryptCipher(iv, key)

    return applyChunkedCipher(cdata, cipher).toByteArray()
//        return cipher.doFinal(cdata)
}

@Throws(GeneralSecurityException::class)
fun createEncryptCipher(key: SecretKey): Cipher {
    loge("enc key: $key")
    val cipher = Cipher.getInstance(CIPHER_SPEC)
    cipher.init(Cipher.ENCRYPT_MODE, key)
    return cipher
}

@Throws(GeneralSecurityException::class)
fun createDecryptCipher(iv: ByteArray, key: SecretKey): Cipher {
    loge("dec key: $key")
    val cipher = Cipher.getInstance(CIPHER_SPEC)
    cipher.init(Cipher.DECRYPT_MODE, key, GCMParameterSpec(CIPHER_TAG_LEN, iv))
    return cipher
}

class EncryptedDataStorage(private val label: String, private val accessRestrictions: AccessRestrictions, private val prefs: SharedPreferences) {

    private val PREF_KEY_ID_PREFIX = "KEY_ID_"
    private val PREF_ENCRYPTED_STATE_PREFIX = "ENCRYPTED_STATE_"
    private val PREF_ENCRYPTED_KEY_PREFIX = "ENCRYPTED_KEY_"
//    private var plainBytes: ByteArray? = null

    private lateinit var wrapper: SecretKeyWrapper

    private var keyId: String? = null
//
//    private fun useMostRecentKey() {
//        keyId = prefs.getString(PREF_KEY_ID_PREFIX + label, null)
//        keyId ?: return
//        wrapper = SecretKeyWrapper("pm.kee.vault.$label.$keyId", accessRestrictions)
//        keystore = getOrCreateKey("pm.kee.vault.$label.$id", accessRestrictions)
//    }
//
////    private fun accessRestrictionsFor(label: String): AccessRestrictions {
////        return when (label) {
////            "cache" -> AccessRestrictions()
////            else -> AccessRestrictions(Date(Date().time + 31556926000), true, -1) // 1 year
////        }
////    }
//
//    private fun setKey(id: String) {
//        keystore = Keystore("pm.kee.vault.$label.$id", accessRestrictions)
//
//    }

    private fun getKey(wrapper: SecretKeyWrapper) : SecretKey {
        val encryptedKey = prefs.getString("$PREF_ENCRYPTED_KEY_PREFIX$label.$keyId", null)
        val ba = encryptedKey?.toByteArray(Charsets.ISO_8859_1)
        ba ?: throw Exception("Secret key not found. Data forcibly removed recently?")
        return wrapper.unwrap(ba)
    }
    private fun createKey(wrapper: SecretKeyWrapper) : SecretKey {
        val raw = ByteArray(32)
        SecureRandom().nextBytes(raw)
        return SecretKeySpec(raw, "AES")
    }

    fun getString() : String? {
//        val temp = """
//            {"id":"Rxkkb9boJkL099RPyzSad4DPgiEnfAXk3pNPwBzbAkA=","config":{"expiry":12,"requireFullKey":false},"vault":{"dbs":[{"name":"My Kee Vault","fileName":"9a8cc281-d249-45b6-781f-f8c5ab07d424","active":true,"root":{"title":"My Kee Vault","iconImageData":"iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAG1SURBVDhPrZNLKERhFMfHY0pKcWehRqZmc5tMUzPdyUJTirCgNAuPWUgSSTbSEAuzUUhNHgvJs1ATeSyQqCGPBRlJWbK7Vta2f+d839wZLiYLp37d7nf+/3PO993vWiiyLbWHMONwOMooZ2VB5iDxT8HrqqpWkSKfyCVyiCzCFCRMvOIbRpHP/DwVJeIvEJw+p5+MOVj7aarkNLQYewTW7iGeTM3C9+5mtEBDP7mpEL1MXyFFx5Y0v70n2/4SrHG73XWiwPAxUpRNyOTOk5xm/QFYSQALt0BDl47ZawhY4/f7w6JA5zYEgTmZ4O0s3QHzN1I8dQGMnwHV7TpGT6TG4/Hs+Xy+VlGgcRWCokGZjF4Ck+fAWBzCwJOF6WuXt+ro2091n7HZbHZRoGIWKI3IhGEYOgIGDiAMvXtA9w6gNeum7nw/aKEwLM0Mi3t2pYEPtC0GhDaBpnU6n6AswN0VRSkRX9EwFo/ITixu2ZCG4JrcWv0yULeY3rvX6w3Z7XZV+MXtShb5C9Q9qsjuqWttdTqd5ZQY1jRtKhOkibhcrkry8L/xJbhaHp1qQSZIY/xY/xUWywdpBtlFmORVPwAAAABJRU5ErkJggg==","uniqueID":"fHlpBgKCQMfsd3Db24c5Aw==","path":"My Kee Vault","childEntries":[{"uRLs":["https://www.fred.fred"],"title":"fred","uniqueID":"4dDFgKng2ioCFyv7iPPKeg==","iconImageData":"iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAJpSURBVDhPjZFtSFNRHMbvXnSTreEstSjn7lbX2QZrbncORVZL/RCN6EuUKX2ICopsUETFekErKste8EMvEERRQZpEiCIUmNBgSipK1CxzZblavm+zzbanI14Ygjl/8HDvPf/nB/ecQyVCJpOlVZZa6lwnlo+fLNW4Z7+5UWJKTKbyRxX0l58vkoBfFAIdfDhsOW4yks41FqGEZfd0XE6NzPTwgAEKI20itF4QxfqvCXBk47p2Ukmeay5ApkSSUX80249eCugi8QnReZuJ2ZTarpZjyX+mXkpwuFD76r/bqS4zt065BEAPkT0kQQoTH7Lw/JAqONDARIG98FWloZg11nHKfM7uyHkfdvOBQSKPkfwl78gCIsXkeZGsH0TDVnGswGS6yinz2V5UeN7zVISonxzcEIVYTEHEbSS3SO7B61wNK53dLZVKV3BKnDy9trT5zJqxwGc+xl08hAaVRNpJUguEriP8MA+VKnFQp9Nt4ZQ4Oo3GWu/MGot842HyHR8zQzQRN5MrtAND+zB8RQGHUjSdz7LnOCWORrPW8thJj4S/8jDVK0D0ewbwQ4HJxpV4u1+M17uFsCvkwwaDoYJT4jAMwz44rfKHvTwEu8me+1Iw0SbHHXtKtCw3dcSi1z8pMBpraJpmOSXOrHz/FOML9AsQ8pDTHl2GvrsS7NKmTpqN7A21Wm3kqgtz6YChN+ARYPojhUinEP4WGRyb5GHyq+VcZXGab64KwEfuelSMpmopihjlJwvL1pCRcK6RgMaqjGlvUxI8z6SwmzN/p6enq7nR0rAV5tfaTLnt1g3r35jN5uPc8hKhqH9mBy2MUTy6KwAAAABJRU5ErkJggg==","hTTPRealm":"","formFieldList":[{"name":"","displayName":"KeePass username","value":"fred1","type":"FFTusername","id":"","page":1},{"name":"","displayName":"KeePass password","value":"fr3d1","type":"FFTpassword","id":"","page":1}],"alwaysAutoFill":false,"neverAutoFill":false,"alwaysAutoSubmit":false,"neverAutoSubmit":false,"priority":0,"parent":{"title":"My Kee Vault","iconImageData":"iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAG1SURBVDhPrZNLKERhFMfHY0pKcWehRqZmc5tMUzPdyUJTirCgNAuPWUgSSTbSEAuzUUhNHgvJs1ATeSyQqCGPBRlJWbK7Vta2f+d839wZLiYLp37d7nf+/3PO993vWiiyLbWHMONwOMooZ2VB5iDxT8HrqqpWkSKfyCVyiCzCFCRMvOIbRpHP/DwVJeIvEJw+p5+MOVj7aarkNLQYewTW7iGeTM3C9+5mtEBDP7mpEL1MXyFFx5Y0v70n2/4SrHG73XWiwPAxUpRNyOTOk5xm/QFYSQALt0BDl47ZawhY4/f7w6JA5zYEgTmZ4O0s3QHzN1I8dQGMnwHV7TpGT6TG4/Hs+Xy+VlGgcRWCokGZjF4Ck+fAWBzCwJOF6WuXt+ro2091n7HZbHZRoGIWKI3IhGEYOgIGDiAMvXtA9w6gNeum7nw/aKEwLM0Mi3t2pYEPtC0GhDaBpnU6n6AswN0VRSkRX9EwFo/ITixu2ZCG4JrcWv0yULeY3rvX6w3Z7XZV+MXtShb5C9Q9qsjuqWttdTqd5ZQY1jRtKhOkibhcrkry8L/xJbhaHp1qQSZIY/xY/xUWywdpBtlFmORVPwAAAABJRU5ErkJggg==","uniqueID":"fHlpBgKCQMfsd3Db24c5Aw==","path":"My Kee Vault"},"db":{"name":"My Kee Vault","fileName":"9a8cc281-d249-45b6-781f-f8c5ab07d424","active":true,"root":{"title":"My Kee Vault","iconImageData":"iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAG1SURBVDhPrZNLKERhFMfHY0pKcWehRqZmc5tMUzPdyUJTirCgNAuPWUgSSTbSEAuzUUhNHgvJs1ATeSyQqCGPBRlJWbK7Vta2f+d839wZLiYLp37d7nf+/3PO993vWiiyLbWHMONwOMooZ2VB5iDxT8HrqqpWkSKfyCVyiCzCFCRMvOIbRpHP/DwVJeIvEJw+p5+MOVj7aarkNLQYewTW7iGeTM3C9+5mtEBDP7mpEL1MXyFFx5Y0v70n2/4SrHG73XWiwPAxUpRNyOTOk5xm/QFYSQALt0BDl47ZawhY4/f7w6JA5zYEgTmZ4O0s3QHzN1I8dQGMnwHV7TpGT6TG4/Hs+Xy+VlGgcRWCokGZjF4Ck+fAWBzCwJOF6WuXt+ro2091n7HZbHZRoGIWKI3IhGEYOgIGDiAMvXtA9w6gNeum7nw/aKEwLM0Mi3t2pYEPtC0GhDaBpnU6n6AswN0VRSkRX9EwFo/ITixu2ZCG4JrcWv0yULeY3rvX6w3Z7XZV+MXtShb5C9Q9qsjuqWttdTqd5ZQY1jRtKhOkibhcrkry8L/xJbhaHp1qQSZIY/xY/xUWywdpBtlFmORVPwAAAABJRU5ErkJggg==","uniqueID":"fHlpBgKCQMfsd3Db24c5Aw==","path":"My Kee Vault"},"iconImageData":"iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAG1SURBVDhPrZNLKERhFMfHY0pKcWehRqZmc5tMUzPdyUJTirCgNAuPWUgSSTbSEAuzUUhNHgvJs1ATeSyQqCGPBRlJWbK7Vta2f+d839wZLiYLp37d7nf+/3PO993vWiiyLbWHMONwOMooZ2VB5iDxT8HrqqpWkSKfyCVyiCzCFCRMvOIbRpHP/DwVJeIvEJw+p5+MOVj7aarkNLQYewTW7iGeTM3C9+5mtEBDP7mpEL1MXyFFx5Y0v70n2/4SrHG73XWiwPAxUpRNyOTOk5xm/QFYSQALt0BDl47ZawhY4/f7w6JA5zYEgTmZ4O0s3QHzN1I8dQGMnwHV7TpGT6TG4/Hs+Xy+VlGgcRWCokGZjF4Ck+fAWBzCwJOF6WuXt+ro2091n7HZbHZRoGIWKI3IhGEYOgIGDiAMvXtA9w6gNeum7nw/aKEwLM0Mi3t2pYEPtC0GhDaBpnU6n6AswN0VRSkRX9EwFo/ITixu2ZCG4JrcWv0yULeY3rvX6w3Z7XZV+MXtShb5C9Q9qsjuqWttdTqd5ZQY1jRtKhOkibhcrkry8L/xJbhaHp1qQSZIY/xY/xUWywdpBtlFmORVPwAAAABJRU5ErkJggg=="},"matchAccuracy":0}],"childLightEntries":[],"childGroups":[{"title":"Import at 06/06/2019, 23:25:44","iconImageData":"iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAHBSURBVDhPpZPdS9NRGMd/vQghRKzdj0Zsiy4mcy/diXRhiARDBw7MBEG6MChFBEG9UKnhoHaziomviDnLfEtDLRGMfAkCESWiC29+f8fH55yjlXOC0gMfHs7z+z7f55zD+VkSF62yeXJxuVy35VuBcEmJTg8R5wtV93q9d0VRKFw+RJldEP4JEa7vc4Ijk1xO7kyK87toPqq8B3OSFflC6X0+X6l0KhNjMLgJrbP5J57GXxNZJJZN83lC6T0ezx1t0PTBFFZ+o1n8JUf5CVNyjOw2jPyAzBa83oDyepsXa0YfDofbtUHNsCm834FJQTWNStPAd0ivQ+or9K5CzxcoqbXpXDL6YDD4UhuUpU0hIxPeCK++mabkYVPHotzRAjTJPUXiNo+n/xiktEFxwhSer8AzofszekrbJ2ieQzc8moT6CSiK2dRlcwxudJqCmvB0Bp4IjVPQ8A7qxuHBW6gehaoRuBW1dT5mcL3FFB6KuFbENWMQl4aYCKNDUNEP9/oMN+/bOit9KBRKWPplyeK8+P3+bCAQiKunVOB2uyPi1iZbSp4F0XaJQaXD4bimDFSoH+SK0+m8ehZEe/SD/W9Y1gG9HgDrgogVBgAAAABJRU5ErkJggg==","uniqueID":"o1aTN2EVz0FrT6L3lL1Aog==","path":"My Kee Vault/Import at 06/06/2019, 23:25:44","childEntries":[{"uRLs":["https://www.fred.fred"],"title":"fred","uniqueID":"yCtFPux5CcR63iOzC6GhfQ==","iconImageData":"iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAJpSURBVDhPjZFtSFNRHMbvXnSTreEstSjn7lbX2QZrbncORVZL/RCN6EuUKX2ICopsUETFekErKste8EMvEERRQZpEiCIUmNBgSipK1CxzZblavm+zzbanI14Ygjl/8HDvPf/nB/ecQyVCJpOlVZZa6lwnlo+fLNW4Z7+5UWJKTKbyRxX0l58vkoBfFAIdfDhsOW4yks41FqGEZfd0XE6NzPTwgAEKI20itF4QxfqvCXBk47p2Ukmeay5ApkSSUX80249eCugi8QnReZuJ2ZTarpZjyX+mXkpwuFD76r/bqS4zt065BEAPkT0kQQoTH7Lw/JAqONDARIG98FWloZg11nHKfM7uyHkfdvOBQSKPkfwl78gCIsXkeZGsH0TDVnGswGS6yinz2V5UeN7zVISonxzcEIVYTEHEbSS3SO7B61wNK53dLZVKV3BKnDy9trT5zJqxwGc+xl08hAaVRNpJUguEriP8MA+VKnFQp9Nt4ZQ4Oo3GWu/MGot842HyHR8zQzQRN5MrtAND+zB8RQGHUjSdz7LnOCWORrPW8thJj4S/8jDVK0D0ewbwQ4HJxpV4u1+M17uFsCvkwwaDoYJT4jAMwz44rfKHvTwEu8me+1Iw0SbHHXtKtCw3dcSi1z8pMBpraJpmOSXOrHz/FOML9AsQ8pDTHl2GvrsS7NKmTpqN7A21Wm3kqgtz6YChN+ARYPojhUinEP4WGRyb5GHyq+VcZXGab64KwEfuelSMpmopihjlJwvL1pCRcK6RgMaqjGlvUxI8z6SwmzN/p6enq7nR0rAV5tfaTLnt1g3r35jN5uPc8hKhqH9mBy2MUTy6KwAAAABJRU5ErkJggg==","hTTPRealm":"","formFieldList":[{"name":"","displayName":"KeePass username","value":"fred1","type":"FFTusername","id":"","page":1},{"name":"","displayName":"KeePass password","value":"fr3d1","type":"FFTpassword","id":"","page":1}],"alwaysAutoFill":false,"neverAutoFill":false,"alwaysAutoSubmit":false,"neverAutoSubmit":false,"priority":0,"parent":{"title":"Import at 06/06/2019, 23:25:44","iconImageData":"iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAHBSURBVDhPpZPdS9NRGMd/vQghRKzdj0Zsiy4mcy/diXRhiARDBw7MBEG6MChFBEG9UKnhoHaziomviDnLfEtDLRGMfAkCESWiC29+f8fH55yjlXOC0gMfHs7z+z7f55zD+VkSF62yeXJxuVy35VuBcEmJTg8R5wtV93q9d0VRKFw+RJldEP4JEa7vc4Ijk1xO7kyK87toPqq8B3OSFflC6X0+X6l0KhNjMLgJrbP5J57GXxNZJJZN83lC6T0ezx1t0PTBFFZ+o1n8JUf5CVNyjOw2jPyAzBa83oDyepsXa0YfDofbtUHNsCm834FJQTWNStPAd0ivQ+or9K5CzxcoqbXpXDL6YDD4UhuUpU0hIxPeCK++mabkYVPHotzRAjTJPUXiNo+n/xiktEFxwhSer8AzofszekrbJ2ieQzc8moT6CSiK2dRlcwxudJqCmvB0Bp4IjVPQ8A7qxuHBW6gehaoRuBW1dT5mcL3FFB6KuFbENWMQl4aYCKNDUNEP9/oMN+/bOit9KBRKWPplyeK8+P3+bCAQiKunVOB2uyPi1iZbSp4F0XaJQaXD4bimDFSoH+SK0+m8ehZEe/SD/W9Y1gG9HgDrgogVBgAAAABJRU5ErkJggg==","uniqueID":"o1aTN2EVz0FrT6L3lL1Aog==","path":"My Kee Vault/Import at 06/06/2019, 23:25:44"},"db":{"name":"My Kee Vault","fileName":"9a8cc281-d249-45b6-781f-f8c5ab07d424","active":true,"root":{"title":"My Kee Vault","iconImageData":"iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAG1SURBVDhPrZNLKERhFMfHY0pKcWehRqZmc5tMUzPdyUJTirCgNAuPWUgSSTbSEAuzUUhNHgvJs1ATeSyQqCGPBRlJWbK7Vta2f+d839wZLiYLp37d7nf+/3PO993vWiiyLbWHMONwOMooZ2VB5iDxT8HrqqpWkSKfyCVyiCzCFCRMvOIbRpHP/DwVJeIvEJw+p5+MOVj7aarkNLQYewTW7iGeTM3C9+5mtEBDP7mpEL1MXyFFx5Y0v70n2/4SrHG73XWiwPAxUpRNyOTOk5xm/QFYSQALt0BDl47ZawhY4/f7w6JA5zYEgTmZ4O0s3QHzN1I8dQGMnwHV7TpGT6TG4/Hs+Xy+VlGgcRWCokGZjF4Ck+fAWBzCwJOF6WuXt+ro2091n7HZbHZRoGIWKI3IhGEYOgIGDiAMvXtA9w6gNeum7nw/aKEwLM0Mi3t2pYEPtC0GhDaBpnU6n6AswN0VRSkRX9EwFo/ITixu2ZCG4JrcWv0yULeY3rvX6w3Z7XZV+MXtShb5C9Q9qsjuqWttdTqd5ZQY1jRtKhOkibhcrkry8L/xJbhaHp1qQSZIY/xY/xUWywdpBtlFmORVPwAAAABJRU5ErkJggg==","uniqueID":"fHlpBgKCQMfsd3Db24c5Aw==","path":"My Kee Vault"},"iconImageData":"iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAG1SURBVDhPrZNLKERhFMfHY0pKcWehRqZmc5tMUzPdyUJTirCgNAuPWUgSSTbSEAuzUUhNHgvJs1ATeSyQqCGPBRlJWbK7Vta2f+d839wZLiYLp37d7nf+/3PO993vWiiyLbWHMONwOMooZ2VB5iDxT8HrqqpWkSKfyCVyiCzCFCRMvOIbRpHP/DwVJeIvEJw+p5+MOVj7aarkNLQYewTW7iGeTM3C9+5mtEBDP7mpEL1MXyFFx5Y0v70n2/4SrHG73XWiwPAxUpRNyOTOk5xm/QFYSQALt0BDl47ZawhY4/f7w6JA5zYEgTmZ4O0s3QHzN1I8dQGMnwHV7TpGT6TG4/Hs+Xy+VlGgcRWCokGZjF4Ck+fAWBzCwJOF6WuXt+ro2091n7HZbHZRoGIWKI3IhGEYOgIGDiAMvXtA9w6gNeum7nw/aKEwLM0Mi3t2pYEPtC0GhDaBpnU6n6AswN0VRSkRX9EwFo/ITixu2ZCG4JrcWv0yULeY3rvX6w3Z7XZV+MXtShb5C9Q9qsjuqWttdTqd5ZQY1jRtKhOkibhcrkry8L/xJbhaHp1qQSZIY/xY/xUWywdpBtlFmORVPwAAAABJRU5ErkJggg=="},"matchAccuracy":0}],"childLightEntries":[],"childGroups":[]},{"title":"Import at 06/06/2019, 23:47:05","iconImageData":"iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAHBSURBVDhPpZPdS9NRGMd/vQghRKzdj0Zsiy4mcy/diXRhiARDBw7MBEG6MChFBEG9UKnhoHaziomviDnLfEtDLRGMfAkCESWiC29+f8fH55yjlXOC0gMfHs7z+z7f55zD+VkSF62yeXJxuVy35VuBcEmJTg8R5wtV93q9d0VRKFw+RJldEP4JEa7vc4Ijk1xO7kyK87toPqq8B3OSFflC6X0+X6l0KhNjMLgJrbP5J57GXxNZJJZN83lC6T0ezx1t0PTBFFZ+o1n8JUf5CVNyjOw2jPyAzBa83oDyepsXa0YfDofbtUHNsCm834FJQTWNStPAd0ivQ+or9K5CzxcoqbXpXDL6YDD4UhuUpU0hIxPeCK++mabkYVPHotzRAjTJPUXiNo+n/xiktEFxwhSer8AzofszekrbJ2ieQzc8moT6CSiK2dRlcwxudJqCmvB0Bp4IjVPQ8A7qxuHBW6gehaoRuBW1dT5mcL3FFB6KuFbENWMQl4aYCKNDUNEP9/oMN+/bOit9KBRKWPplyeK8+P3+bCAQiKunVOB2uyPi1iZbSp4F0XaJQaXD4bimDFSoH+SK0+m8ehZEe/SD/W9Y1gG9HgDrgogVBgAAAABJRU5ErkJggg==","uniqueID":"xTAOi3HFL47c9FmB9RqCng==","path":"My Kee Vault/Import at 06/06/2019, 23:47:05","childEntries":[{"uRLs":["https://www.fred.fred"],"title":"fred","uniqueID":"dpeCRLagLKC6b0tDVaALgA==","iconImageData":"iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAJpSURBVDhPjZFtSFNRHMbvXnSTreEstSjn7lbX2QZrbncORVZL/RCN6EuUKX2ICopsUETFekErKste8EMvEERRQZpEiCIUmNBgSipK1CxzZblavm+zzbanI14Ygjl/8HDvPf/nB/ecQyVCJpOlVZZa6lwnlo+fLNW4Z7+5UWJKTKbyRxX0l58vkoBfFAIdfDhsOW4yks41FqGEZfd0XE6NzPTwgAEKI20itF4QxfqvCXBk47p2Ukmeay5ApkSSUX80249eCugi8QnReZuJ2ZTarpZjyX+mXkpwuFD76r/bqS4zt065BEAPkT0kQQoTH7Lw/JAqONDARIG98FWloZg11nHKfM7uyHkfdvOBQSKPkfwl78gCIsXkeZGsH0TDVnGswGS6yinz2V5UeN7zVISonxzcEIVYTEHEbSS3SO7B61wNK53dLZVKV3BKnDy9trT5zJqxwGc+xl08hAaVRNpJUguEriP8MA+VKnFQp9Nt4ZQ4Oo3GWu/MGot842HyHR8zQzQRN5MrtAND+zB8RQGHUjSdz7LnOCWORrPW8thJj4S/8jDVK0D0ewbwQ4HJxpV4u1+M17uFsCvkwwaDoYJT4jAMwz44rfKHvTwEu8me+1Iw0SbHHXtKtCw3dcSi1z8pMBpraJpmOSXOrHz/FOML9AsQ8pDTHl2GvrsS7NKmTpqN7A21Wm3kqgtz6YChN+ARYPojhUinEP4WGRyb5GHyq+VcZXGab64KwEfuelSMpmopihjlJwvL1pCRcK6RgMaqjGlvUxI8z6SwmzN/p6enq7nR0rAV5tfaTLnt1g3r35jN5uPc8hKhqH9mBy2MUTy6KwAAAABJRU5ErkJggg==","hTTPRealm":"","formFieldList":[{"name":"","displayName":"KeePass username","value":"fred1","type":"FFTusername","id":"","page":1},{"name":"","displayName":"KeePass password","value":"fr3d1","type":"FFTpassword","id":"","page":1}],"alwaysAutoFill":false,"neverAutoFill":false,"alwaysAutoSubmit":false,"neverAutoSubmit":false,"priority":0,"parent":{"title":"Import at 06/06/2019, 23:47:05","iconImageData":"iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAHBSURBVDhPpZPdS9NRGMd/vQghRKzdj0Zsiy4mcy/diXRhiARDBw7MBEG6MChFBEG9UKnhoHaziomviDnLfEtDLRGMfAkCESWiC29+f8fH55yjlXOC0gMfHs7z+z7f55zD+VkSF62yeXJxuVy35VuBcEmJTg8R5wtV93q9d0VRKFw+RJldEP4JEa7vc4Ijk1xO7kyK87toPqq8B3OSFflC6X0+X6l0KhNjMLgJrbP5J57GXxNZJJZN83lC6T0ezx1t0PTBFFZ+o1n8JUf5CVNyjOw2jPyAzBa83oDyepsXa0YfDofbtUHNsCm834FJQTWNStPAd0ivQ+or9K5CzxcoqbXpXDL6YDD4UhuUpU0hIxPeCK++mabkYVPHotzRAjTJPUXiNo+n/xiktEFxwhSer8AzofszekrbJ2ieQzc8moT6CSiK2dRlcwxudJqCmvB0Bp4IjVPQ8A7qxuHBW6gehaoRuBW1dT5mcL3FFB6KuFbENWMQl4aYCKNDUNEP9/oMN+/bOit9KBRKWPplyeK8+P3+bCAQiKunVOB2uyPi1iZbSp4F0XaJQaXD4bimDFSoH+SK0+m8ehZEe/SD/W9Y1gG9HgDrgogVBgAAAABJRU5ErkJggg==","uniqueID":"xTAOi3HFL47c9FmB9RqCng==","path":"My Kee Vault/Import at 06/06/2019, 23:47:05"},"db":{"name":"My Kee Vault","fileName":"9a8cc281-d249-45b6-781f-f8c5ab07d424","active":true,"root":{"title":"My Kee Vault","iconImageData":"iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAG1SURBVDhPrZNLKERhFMfHY0pKcWehRqZmc5tMUzPdyUJTirCgNAuPWUgSSTbSEAuzUUhNHgvJs1ATeSyQqCGPBRlJWbK7Vta2f+d839wZLiYLp37d7nf+/3PO993vWiiyLbWHMONwOMooZ2VB5iDxT8HrqqpWkSKfyCVyiCzCFCRMvOIbRpHP/DwVJeIvEJw+p5+MOVj7aarkNLQYewTW7iGeTM3C9+5mtEBDP7mpEL1MXyFFx5Y0v70n2/4SrHG73XWiwPAxUpRNyOTOk5xm/QFYSQALt0BDl47ZawhY4/f7w6JA5zYEgTmZ4O0s3QHzN1I8dQGMnwHV7TpGT6TG4/Hs+Xy+VlGgcRWCokGZjF4Ck+fAWBzCwJOF6WuXt+ro2091n7HZbHZRoGIWKI3IhGEYOgIGDiAMvXtA9w6gNeum7nw/aKEwLM0Mi3t2pYEPtC0GhDaBpnU6n6AswN0VRSkRX9EwFo/ITixu2ZCG4JrcWv0yULeY3rvX6w3Z7XZV+MXtShb5C9Q9qsjuqWttdTqd5ZQY1jRtKhOkibhcrkry8L/xJbhaHp1qQSZIY/xY/xUWywdpBtlFmORVPwAAAABJRU5ErkJggg==","uniqueID":"fHlpBgKCQMfsd3Db24c5Aw==","path":"My Kee Vault"},"iconImageData":"iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAG1SURBVDhPrZNLKERhFMfHY0pKcWehRqZmc5tMUzPdyUJTirCgNAuPWUgSSTbSEAuzUUhNHgvJs1ATeSyQqCGPBRlJWbK7Vta2f+d839wZLiYLp37d7nf+/3PO993vWiiyLbWHMONwOMooZ2VB5iDxT8HrqqpWkSKfyCVyiCzCFCRMvOIbRpHP/DwVJeIvEJw+p5+MOVj7aarkNLQYewTW7iGeTM3C9+5mtEBDP7mpEL1MXyFFx5Y0v70n2/4SrHG73XWiwPAxUpRNyOTOk5xm/QFYSQALt0BDl47ZawhY4/f7w6JA5zYEgTmZ4O0s3QHzN1I8dQGMnwHV7TpGT6TG4/Hs+Xy+VlGgcRWCokGZjF4Ck+fAWBzCwJOF6WuXt+ro2091n7HZbHZRoGIWKI3IhGEYOgIGDiAMvXtA9w6gNeum7nw/aKEwLM0Mi3t2pYEPtC0GhDaBpnU6n6AswN0VRSkRX9EwFo/ITixu2ZCG4JrcWv0yULeY3rvX6w3Z7XZV+MXtShb5C9Q9qsjuqWttdTqd5ZQY1jRtKhOkibhcrkry8L/xJbhaHp1qQSZIY/xY/xUWywdpBtlFmORVPwAAAABJRU5ErkJggg=="},"matchAccuracy":0},{"uRLs":["https://www.fred.fred"],"title":"fred","uniqueID":"HdK+cqtL7FZkMNxFdrarmg==","iconImageData":"iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAJpSURBVDhPjZFtSFNRHMbvXnSTreEstSjn7lbX2QZrbncORVZL/RCN6EuUKX2ICopsUETFekErKste8EMvEERRQZpEiCIUmNBgSipK1CxzZblavm+zzbanI14Ygjl/8HDvPf/nB/ecQyVCJpOlVZZa6lwnlo+fLNW4Z7+5UWJKTKbyRxX0l58vkoBfFAIdfDhsOW4yks41FqGEZfd0XE6NzPTwgAEKI20itF4QxfqvCXBk47p2Ukmeay5ApkSSUX80249eCugi8QnReZuJ2ZTarpZjyX+mXkpwuFD76r/bqS4zt065BEAPkT0kQQoTH7Lw/JAqONDARIG98FWloZg11nHKfM7uyHkfdvOBQSKPkfwl78gCIsXkeZGsH0TDVnGswGS6yinz2V5UeN7zVISonxzcEIVYTEHEbSS3SO7B61wNK53dLZVKV3BKnDy9trT5zJqxwGc+xl08hAaVRNpJUguEriP8MA+VKnFQp9Nt4ZQ4Oo3GWu/MGot842HyHR8zQzQRN5MrtAND+zB8RQGHUjSdz7LnOCWORrPW8thJj4S/8jDVK0D0ewbwQ4HJxpV4u1+M17uFsCvkwwaDoYJT4jAMwz44rfKHvTwEu8me+1Iw0SbHHXtKtCw3dcSi1z8pMBpraJpmOSXOrHz/FOML9AsQ8pDTHl2GvrsS7NKmTpqN7A21Wm3kqgtz6YChN+ARYPojhUinEP4WGRyb5GHyq+VcZXGab64KwEfuelSMpmopihjlJwvL1pCRcK6RgMaqjGlvUxI8z6SwmzN/p6enq7nR0rAV5tfaTLnt1g3r35jN5uPc8hKhqH9mBy2MUTy6KwAAAABJRU5ErkJggg==","hTTPRealm":"","formFieldList":[{"name":"","displayName":"KeePass username","value":"fred1","type":"FFTusername","id":"","page":1},{"name":"","displayName":"KeePass password","value":"fr3d1","type":"FFTpassword","id":"","page":1}],"alwaysAutoFill":false,"neverAutoFill":false,"alwaysAutoSubmit":false,"neverAutoSubmit":false,"priority":0,"parent":{"title":"Import at 06/06/2019, 23:47:05","iconImageData":"iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAHBSURBVDhPpZPdS9NRGMd/vQghRKzdj0Zsiy4mcy/diXRhiARDBw7MBEG6MChFBEG9UKnhoHaziomviDnLfEtDLRGMfAkCESWiC29+f8fH55yjlXOC0gMfHs7z+z7f55zD+VkSF62yeXJxuVy35VuBcEmJTg8R5wtV93q9d0VRKFw+RJldEP4JEa7vc4Ijk1xO7kyK87toPqq8B3OSFflC6X0+X6l0KhNjMLgJrbP5J57GXxNZJJZN83lC6T0ezx1t0PTBFFZ+o1n8JUf5CVNyjOw2jPyAzBa83oDyepsXa0YfDofbtUHNsCm834FJQTWNStPAd0ivQ+or9K5CzxcoqbXpXDL6YDD4UhuUpU0hIxPeCK++mabkYVPHotzRAjTJPUXiNo+n/xiktEFxwhSer8AzofszekrbJ2ieQzc8moT6CSiK2dRlcwxudJqCmvB0Bp4IjVPQ8A7qxuHBW6gehaoRuBW1dT5mcL3FFB6KuFbENWMQl4aYCKNDUNEP9/oMN+/bOit9KBRKWPplyeK8+P3+bCAQiKunVOB2uyPi1iZbSp4F0XaJQaXD4bimDFSoH+SK0+m8ehZEe/SD/W9Y1gG9HgDrgogVBgAAAABJRU5ErkJggg==","uniqueID":"xTAOi3HFL47c9FmB9RqCng==","path":"My Kee Vault/Import at 06/06/2019, 23:47:05"},"db":{"name":"My Kee Vault","fileName":"9a8cc281-d249-45b6-781f-f8c5ab07d424","active":true,"root":{"title":"My Kee Vault","iconImageData":"iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAG1SURBVDhPrZNLKERhFMfHY0pKcWehRqZmc5tMUzPdyUJTirCgNAuPWUgSSTbSEAuzUUhNHgvJs1ATeSyQqCGPBRlJWbK7Vta2f+d839wZLiYLp37d7nf+/3PO993vWiiyLbWHMONwOMooZ2VB5iDxT8HrqqpWkSKfyCVyiCzCFCRMvOIbRpHP/DwVJeIvEJw+p5+MOVj7aarkNLQYewTW7iGeTM3C9+5mtEBDP7mpEL1MXyFFx5Y0v70n2/4SrHG73XWiwPAxUpRNyOTOk5xm/QFYSQALt0BDl47ZawhY4/f7w6JA5zYEgTmZ4O0s3QHzN1I8dQGMnwHV7TpGT6TG4/Hs+Xy+VlGgcRWCokGZjF4Ck+fAWBzCwJOF6WuXt+ro2091n7HZbHZRoGIWKI3IhGEYOgIGDiAMvXtA9w6gNeum7nw/aKEwLM0Mi3t2pYEPtC0GhDaBpnU6n6AswN0VRSkRX9EwFo/ITixu2ZCG4JrcWv0yULeY3rvX6w3Z7XZV+MXtShb5C9Q9qsjuqWttdTqd5ZQY1jRtKhOkibhcrkry8L/xJbhaHp1qQSZIY/xY/xUWywdpBtlFmORVPwAAAABJRU5ErkJggg==","uniqueID":"fHlpBgKCQMfsd3Db24c5Aw==","path":"My Kee Vault"},"iconImageData":"iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAG1SURBVDhPrZNLKERhFMfHY0pKcWehRqZmc5tMUzPdyUJTirCgNAuPWUgSSTbSEAuzUUhNHgvJs1ATeSyQqCGPBRlJWbK7Vta2f+d839wZLiYLp37d7nf+/3PO993vWiiyLbWHMONwOMooZ2VB5iDxT8HrqqpWkSKfyCVyiCzCFCRMvOIbRpHP/DwVJeIvEJw+p5+MOVj7aarkNLQYewTW7iGeTM3C9+5mtEBDP7mpEL1MXyFFx5Y0v70n2/4SrHG73XWiwPAxUpRNyOTOk5xm/QFYSQALt0BDl47ZawhY4/f7w6JA5zYEgTmZ4O0s3QHzN1I8dQGMnwHV7TpGT6TG4/Hs+Xy+VlGgcRWCokGZjF4Ck+fAWBzCwJOF6WuXt+ro2091n7HZbHZRoGIWKI3IhGEYOgIGDiAMvXtA9w6gNeum7nw/aKEwLM0Mi3t2pYEPtC0GhDaBpnU6n6AswN0VRSkRX9EwFo/ITixu2ZCG4JrcWv0yULeY3rvX6w3Z7XZV+MXtShb5C9Q9qsjuqWttdTqd5ZQY1jRtKhOkibhcrkry8L/xJbhaHp1qQSZIY/xY/xUWywdpBtlFmORVPwAAAABJRU5ErkJggg=="},"matchAccuracy":0}],"childLightEntries":[],"childGroups":[]},{"title":"Import at 6/7/2019, 12:31:03 PM","iconImageData":"iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAHBSURBVDhPpZPdS9NRGMd/vQghRKzdj0Zsiy4mcy/diXRhiARDBw7MBEG6MChFBEG9UKnhoHaziomviDnLfEtDLRGMfAkCESWiC29+f8fH55yjlXOC0gMfHs7z+z7f55zD+VkSF62yeXJxuVy35VuBcEmJTg8R5wtV93q9d0VRKFw+RJldEP4JEa7vc4Ijk1xO7kyK87toPqq8B3OSFflC6X0+X6l0KhNjMLgJrbP5J57GXxNZJJZN83lC6T0ezx1t0PTBFFZ+o1n8JUf5CVNyjOw2jPyAzBa83oDyepsXa0YfDofbtUHNsCm834FJQTWNStPAd0ivQ+or9K5CzxcoqbXpXDL6YDD4UhuUpU0hIxPeCK++mabkYVPHotzRAjTJPUXiNo+n/xiktEFxwhSer8AzofszekrbJ2ieQzc8moT6CSiK2dRlcwxudJqCmvB0Bp4IjVPQ8A7qxuHBW6gehaoRuBW1dT5mcL3FFB6KuFbENWMQl4aYCKNDUNEP9/oMN+/bOit9KBRKWPplyeK8+P3+bCAQiKunVOB2uyPi1iZbSp4F0XaJQaXD4bimDFSoH+SK0+m8ehZEe/SD/W9Y1gG9HgDrgogVBgAAAABJRU5ErkJggg==","uniqueID":"PqwJanCDK2WIaF/Nz8DzFQ==","path":"My Kee Vault/Import at 6/7/2019, 12:31:03 PM","childEntries":[{"uRLs":["https://www.fred.fred"],"title":"fred","uniqueID":"5Yf+N1Zjv43b7CxFQ7OyzA==","iconImageData":"iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAJpSURBVDhPjZFtSFNRHMbvXnSTreEstSjn7lbX2QZrbncORVZL/RCN6EuUKX2ICopsUETFekErKste8EMvEERRQZpEiCIUmNBgSipK1CxzZblavm+zzbanI14Ygjl/8HDvPf/nB/ecQyVCJpOlVZZa6lwnlo+fLNW4Z7+5UWJKTKbyRxX0l58vkoBfFAIdfDhsOW4yks41FqGEZfd0XE6NzPTwgAEKI20itF4QxfqvCXBk47p2Ukmeay5ApkSSUX80249eCugi8QnReZuJ2ZTarpZjyX+mXkpwuFD76r/bqS4zt065BEAPkT0kQQoTH7Lw/JAqONDARIG98FWloZg11nHKfM7uyHkfdvOBQSKPkfwl78gCIsXkeZGsH0TDVnGswGS6yinz2V5UeN7zVISonxzcEIVYTEHEbSS3SO7B61wNK53dLZVKV3BKnDy9trT5zJqxwGc+xl08hAaVRNpJUguEriP8MA+VKnFQp9Nt4ZQ4Oo3GWu/MGot842HyHR8zQzQRN5MrtAND+zB8RQGHUjSdz7LnOCWORrPW8thJj4S/8jDVK0D0ewbwQ4HJxpV4u1+M17uFsCvkwwaDoYJT4jAMwz44rfKHvTwEu8me+1Iw0SbHHXtKtCw3dcSi1z8pMBpraJpmOSXOrHz/FOML9AsQ8pDTHl2GvrsS7NKmTpqN7A21Wm3kqgtz6YChN+ARYPojhUinEP4WGRyb5GHyq+VcZXGab64KwEfuelSMpmopihjlJwvL1pCRcK6RgMaqjGlvUxI8z6SwmzN/p6enq7nR0rAV5tfaTLnt1g3r35jN5uPc8hKhqH9mBy2MUTy6KwAAAABJRU5ErkJggg==","hTTPRealm":"","formFieldList":[{"name":"","displayName":"KeePass username","value":"fred1","type":"FFTusername","id":"","page":1},{"name":"","displayName":"KeePass password","value":"fr3d1","type":"FFTpassword","id":"","page":1}],"alwaysAutoFill":false,"neverAutoFill":false,"alwaysAutoSubmit":false,"neverAutoSubmit":false,"priority":0,"parent":{"title":"Import at 6/7/2019, 12:31:03 PM","iconImageData":"iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAHBSURBVDhPpZPdS9NRGMd/vQghRKzdj0Zsiy4mcy/diXRhiARDBw7MBEG6MChFBEG9UKnhoHaziomviDnLfEtDLRGMfAkCESWiC29+f8fH55yjlXOC0gMfHs7z+z7f55zD+VkSF62yeXJxuVy35VuBcEmJTg8R5wtV93q9d0VRKFw+RJldEP4JEa7vc4Ijk1xO7kyK87toPqq8B3OSFflC6X0+X6l0KhNjMLgJrbP5J57GXxNZJJZN83lC6T0ezx1t0PTBFFZ+o1n8JUf5CVNyjOw2jPyAzBa83oDyepsXa0YfDofbtUHNsCm834FJQTWNStPAd0ivQ+or9K5CzxcoqbXpXDL6YDD4UhuUpU0hIxPeCK++mabkYVPHotzRAjTJPUXiNo+n/xiktEFxwhSer8AzofszekrbJ2ieQzc8moT6CSiK2dRlcwxudJqCmvB0Bp4IjVPQ8A7qxuHBW6gehaoRuBW1dT5mcL3FFB6KuFbENWMQl4aYCKNDUNEP9/oMN+/bOit9KBRKWPplyeK8+P3+bCAQiKunVOB2uyPi1iZbSp4F0XaJQaXD4bimDFSoH+SK0+m8ehZEe/SD/W9Y1gG9HgDrgogVBgAAAABJRU5ErkJggg==","uniqueID":"PqwJanCDK2WIaF/Nz8DzFQ==","path":"My Kee Vault/Import at 6/7/2019, 12:31:03 PM"},"db":{"name":"My Kee Vault","fileName":"9a8cc281-d249-45b6-781f-f8c5ab07d424","active":true,"root":{"title":"My Kee Vault","iconImageData":"iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAG1SURBVDhPrZNLKERhFMfHY0pKcWehRqZmc5tMUzPdyUJTirCgNAuPWUgSSTbSEAuzUUhNHgvJs1ATeSyQqCGPBRlJWbK7Vta2f+d839wZLiYLp37d7nf+/3PO993vWiiyLbWHMONwOMooZ2VB5iDxT8HrqqpWkSKfyCVyiCzCFCRMvOIbRpHP/DwVJeIvEJw+p5+MOVj7aarkNLQYewTW7iGeTM3C9+5mtEBDP7mpEL1MXyFFx5Y0v70n2/4SrHG73XWiwPAxUpRNyOTOk5xm/QFYSQALt0BDl47ZawhY4/f7w6JA5zYEgTmZ4O0s3QHzN1I8dQGMnwHV7TpGT6TG4/Hs+Xy+VlGgcRWCokGZjF4Ck+fAWBzCwJOF6WuXt+ro2091n7HZbHZRoGIWKI3IhGEYOgIGDiAMvXtA9w6gNeum7nw/aKEwLM0Mi3t2pYEPtC0GhDaBpnU6n6AswN0VRSkRX9EwFo/ITixu2ZCG4JrcWv0yULeY3rvX6w3Z7XZV+MXtShb5C9Q9qsjuqWttdTqd5ZQY1jRtKhOkibhcrkry8L/xJbhaHp1qQSZIY/xY/xUWywdpBtlFmORVPwAAAABJRU5ErkJggg==","uniqueID":"fHlpBgKCQMfsd3Db24c5Aw==","path":"My Kee Vault"},"iconImageData":"iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAG1SURBVDhPrZNLKERhFMfHY0pKcWehRqZmc5tMUzPdyUJTirCgNAuPWUgSSTbSEAuzUUhNHgvJs1ATeSyQqCGPBRlJWbK7Vta2f+d839wZLiYLp37d7nf+/3PO993vWiiyLbWHMONwOMooZ2VB5iDxT8HrqqpWkSKfyCVyiCzCFCRMvOIbRpHP/DwVJeIvEJw+p5+MOVj7aarkNLQYewTW7iGeTM3C9+5mtEBDP7mpEL1MXyFFx5Y0v70n2/4SrHG73XWiwPAxUpRNyOTOk5xm/QFYSQALt0BDl47ZawhY4/f7w6JA5zYEgTmZ4O0s3QHzN1I8dQGMnwHV7TpGT6TG4/Hs+Xy+VlGgcRWCokGZjF4Ck+fAWBzCwJOF6WuXt+ro2091n7HZbHZRoGIWKI3IhGEYOgIGDiAMvXtA9w6gNeum7nw/aKEwLM0Mi3t2pYEPtC0GhDaBpnU6n6AswN0VRSkRX9EwFo/ITixu2ZCG4JrcWv0yULeY3rvX6w3Z7XZV+MXtShb5C9Q9qsjuqWttdTqd5ZQY1jRtKhOkibhcrkry8L/xJbhaHp1qQSZIY/xY/xUWywdpBtlFmORVPwAAAABJRU5ErkJggg=="},"matchAccuracy":0},{"uRLs":["https://www.fred.fred"],"title":"fred","uniqueID":"8qViigvgoeOZhf/yxpCdlg==","iconImageData":"iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAJpSURBVDhPjZFtSFNRHMbvXnSTreEstSjn7lbX2QZrbncORVZL/RCN6EuUKX2ICopsUETFekErKste8EMvEERRQZpEiCIUmNBgSipK1CxzZblavm+zzbanI14Ygjl/8HDvPf/nB/ecQyVCJpOlVZZa6lwnlo+fLNW4Z7+5UWJKTKbyRxX0l58vkoBfFAIdfDhsOW4yks41FqGEZfd0XE6NzPTwgAEKI20itF4QxfqvCXBk47p2Ukmeay5ApkSSUX80249eCugi8QnReZuJ2ZTarpZjyX+mXkpwuFD76r/bqS4zt065BEAPkT0kQQoTH7Lw/JAqONDARIG98FWloZg11nHKfM7uyHkfdvOBQSKPkfwl78gCIsXkeZGsH0TDVnGswGS6yinz2V5UeN7zVISonxzcEIVYTEHEbSS3SO7B61wNK53dLZVKV3BKnDy9trT5zJqxwGc+xl08hAaVRNpJUguEriP8MA+VKnFQp9Nt4ZQ4Oo3GWu/MGot842HyHR8zQzQRN5MrtAND+zB8RQGHUjSdz7LnOCWORrPW8thJj4S/8jDVK0D0ewbwQ4HJxpV4u1+M17uFsCvkwwaDoYJT4jAMwz44rfKHvTwEu8me+1Iw0SbHHXtKtCw3dcSi1z8pMBpraJpmOSXOrHz/FOML9AsQ8pDTHl2GvrsS7NKmTpqN7A21Wm3kqgtz6YChN+ARYPojhUinEP4WGRyb5GHyq+VcZXGab64KwEfuelSMpmopihjlJwvL1pCRcK6RgMaqjGlvUxI8z6SwmzN/p6enq7nR0rAV5tfaTLnt1g3r35jN5uPc8hKhqH9mBy2MUTy6KwAAAABJRU5ErkJggg==","hTTPRealm":"","formFieldList":[{"name":"","displayName":"KeePass username","value":"fred1","type":"FFTusername","id":"","page":1},{"name":"","displayName":"KeePass password","value":"fr3d1","type":"FFTpassword","id":"","page":1}],"alwaysAutoFill":false,"neverAutoFill":false,"alwaysAutoSubmit":false,"neverAutoSubmit":false,"priority":0,"parent":{"title":"Import at 6/7/2019, 12:31:03 PM","iconImageData":"iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAHBSURBVDhPpZPdS9NRGMd/vQghRKzdj0Zsiy4mcy/diXRhiARDBw7MBEG6MChFBEG9UKnhoHaziomviDnLfEtDLRGMfAkCESWiC29+f8fH55yjlXOC0gMfHs7z+z7f55zD+VkSF62yeXJxuVy35VuBcEmJTg8R5wtV93q9d0VRKFw+RJldEP4JEa7vc4Ijk1xO7kyK87toPqq8B3OSFflC6X0+X6l0KhNjMLgJrbP5J57GXxNZJJZN83lC6T0ezx1t0PTBFFZ+o1n8JUf5CVNyjOw2jPyAzBa83oDyepsXa0YfDofbtUHNsCm834FJQTWNStPAd0ivQ+or9K5CzxcoqbXpXDL6YDD4UhuUpU0hIxPeCK++mabkYVPHotzRAjTJPUXiNo+n/xiktEFxwhSer8AzofszekrbJ2ieQzc8moT6CSiK2dRlcwxudJqCmvB0Bp4IjVPQ8A7qxuHBW6gehaoRuBW1dT5mcL3FFB6KuFbENWMQl4aYCKNDUNEP9/oMN+/bOit9KBRKWPplyeK8+P3+bCAQiKunVOB2uyPi1iZbSp4F0XaJQaXD4bimDFSoH+SK0+m8ehZEe/SD/W9Y1gG9HgDrgogVBgAAAABJRU5ErkJggg==","uniqueID":"PqwJanCDK2WIaF/Nz8DzFQ==","path":"My Kee Vault/Import at 6/7/2019, 12:31:03 PM"},"db":{"name":"My Kee Vault","fileName":"9a8cc281-d249-45b6-781f-f8c5ab07d424","active":true,"root":{"title":"My Kee Vault","iconImageData":"iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAG1SURBVDhPrZNLKERhFMfHY0pKcWehRqZmc5tMUzPdyUJTirCgNAuPWUgSSTbSEAuzUUhNHgvJs1ATeSyQqCGPBRlJWbK7Vta2f+d839wZLiYLp37d7nf+/3PO993vWiiyLbWHMONwOMooZ2VB5iDxT8HrqqpWkSKfyCVyiCzCFCRMvOIbRpHP/DwVJeIvEJw+p5+MOVj7aarkNLQYewTW7iGeTM3C9+5mtEBDP7mpEL1MXyFFx5Y0v70n2/4SrHG73XWiwPAxUpRNyOTOk5xm/QFYSQALt0BDl47ZawhY4/f7w6JA5zYEgTmZ4O0s3QHzN1I8dQGMnwHV7TpGT6TG4/Hs+Xy+VlGgcRWCokGZjF4Ck+fAWBzCwJOF6WuXt+ro2091n7HZbHZRoGIWKI3IhGEYOgIGDiAMvXtA9w6gNeum7nw/aKEwLM0Mi3t2pYEPtC0GhDaBpnU6n6AswN0VRSkRX9EwFo/ITixu2ZCG4JrcWv0yULeY3rvX6w3Z7XZV+MXtShb5C9Q9qsjuqWttdTqd5ZQY1jRtKhOkibhcrkry8L/xJbhaHp1qQSZIY/xY/xUWywdpBtlFmORVPwAAAABJRU5ErkJggg==","uniqueID":"fHlpBgKCQMfsd3Db24c5Aw==","path":"My Kee Vault"},"iconImageData":"iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAG1SURBVDhPrZNLKERhFMfHY0pKcWehRqZmc5tMUzPdyUJTirCgNAuPWUgSSTbSEAuzUUhNHgvJs1ATeSyQqCGPBRlJWbK7Vta2f+d839wZLiYLp37d7nf+/3PO993vWiiyLbWHMONwOMooZ2VB5iDxT8HrqqpWkSKfyCVyiCzCFCRMvOIbRpHP/DwVJeIvEJw+p5+MOVj7aarkNLQYewTW7iGeTM3C9+5mtEBDP7mpEL1MXyFFx5Y0v70n2/4SrHG73XWiwPAxUpRNyOTOk5xm/QFYSQALt0BDl47ZawhY4/f7w6JA5zYEgTmZ4O0s3QHzN1I8dQGMnwHV7TpGT6TG4/Hs+Xy+VlGgcRWCokGZjF4Ck+fAWBzCwJOF6WuXt+ro2091n7HZbHZRoGIWKI3IhGEYOgIGDiAMvXtA9w6gNeum7nw/aKEwLM0Mi3t2pYEPtC0GhDaBpnU6n6AswN0VRSkRX9EwFo/ITixu2ZCG4JrcWv0yULeY3rvX6w3Z7XZV+MXtShb5C9Q9qsjuqWttdTqd5ZQY1jRtKhOkibhcrkry8L/xJbhaHp1qQSZIY/xY/xUWywdpBtlFmORVPwAAAABJRU5ErkJggg=="},"matchAccuracy":0}],"childLightEntries":[],"childGroups":[]}]},"iconImageData":"iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAG1SURBVDhPrZNLKERhFMfHY0pKcWehRqZmc5tMUzPdyUJTirCgNAuPWUgSSTbSEAuzUUhNHgvJs1ATeSyQqCGPBRlJWbK7Vta2f+d839wZLiYLp37d7nf+/3PO993vWiiyLbWHMONwOMooZ2VB5iDxT8HrqqpWkSKfyCVyiCzCFCRMvOIbRpHP/DwVJeIvEJw+p5+MOVj7aarkNLQYewTW7iGeTM3C9+5mtEBDP7mpEL1MXyFFx5Y0v70n2/4SrHG73XWiwPAxUpRNyOTOk5xm/QFYSQALt0BDl47ZawhY4/f7w6JA5zYEgTmZ4O0s3QHzN1I8dQGMnwHV7TpGT6TG4/Hs+Xy+VlGgcRWCokGZjF4Ck+fAWBzCwJOF6WuXt+ro2091n7HZbHZRoGIWKI3IhGEYOgIGDiAMvXtA9w6gNeum7nw/aKEwLM0Mi3t2pYEPtC0GhDaBpnU6n6AswN0VRSkRX9EwFo/ITixu2ZCG4JrcWv0yULeY3rvX6w3Z7XZV+MXtShb5C9Q9qsjuqWttdTqd5ZQY1jRtKhOkibhcrkry8L/xJbhaHp1qQSZIY/xY/xUWywdpBtlFmORVPwAAAABJRU5ErkJggg=="}],"config":{"settings":{"autoFillForms":true,"autoFillFormsWithMultipleMatches":false,"autoSubmitForms":false,"autoSubmitMatchedForms":true,"listAllOpenDBs":true,"logLevel":4,"mruGroup":{"6ba66e45-22ea-b9a3-baca-d52d85b4480b":"bHHdB+e2C02EFXzu1FdXKA==","354dc1e6-aee8-f904-8490-476061bca0f5":"KVlzSK9fKEmyyGEhWr13AQ==","/home/luckyrat/Dropbox/TheLuckyratDatabase.kdbx":"F2D2605BE923204C851553180C58755A","e48792f0-e933-b164-52a9-bae1fb864730":"tpzRSkNWVv1KY1ZAmykPPQ==","1d680e22-b9d2-4d05-1f4a-2f0328f5ec5b":"pCqbOXpLFc3MruxNaewOrg==","6c10c076-2c91-d0f6-98af-9df127907542":"vQ4bJfqt0jX5EivgvPBCNQ=="},"notifyWhenEntryUpdated":true,"overWriteFieldsAutomatically":true,"rememberMRUDB":true,"rememberMRUGroup":true,"saveFavicons":true,"searchAllOpenDBs":true,"siteConfig":{"pageRegex":{"^.*${'$'}":{"config":{"preventSaveNotification":false,"blackList":{"form":{"names":["search"],"ids":["search"]},"fields":{"names":["search","q","query"],"ids":["search","q"]}},"whiteList":{"form":{"names":["login"],"ids":["login"]},"fields":{"names":["username","j_username","user_name","user","user-name","login","vb_login_username","name","user name","user id","user-id","userid","email","e-mail","id","form_loginname","wpname","mail","loginid","login id","login_name","openid_identifier","authentication_email","openid","auth_email","auth_id","authentication_identifier","authentication_id","customer_number","customernumber","onlineid"],"ids":["username","j_username","user_name","user","user-name","login","vb_login_username","name","user-id","userid","email","e-mail","id","form_loginname","wpname","mail","loginid","login_name","openid_identifier","authentication_email","openid","auth_email","auth_id","authentication_identifier","authentication_id","customer_number","customernumber","onlineid"]}}},"matchWeight":0,"source":"Default"}},"hostExact":{"www.google.co.uk":{"config":{"preventSaveNotification":true},"source":"User","matchWeight":100},"ssdafsdaf":{"config":{},"source":"User","matchWeight":100},"sadfsdfvbsdgfbsdfgb":{"config":{},"source":"User","matchWeight":10},"sgzfddfzgvbdf":{"config":{},"source":"User","matchWeight":100},"sdfbgdfjhngfhdjdfghnfgh":{"config":{"preventSaveNotification":true},"source":"User","matchWeight":100},"fdsrtjftghnvcbn":{"config":{},"source":"User","matchWeight":100},"fdsrtjftghnvcssadfasdfbn":{"config":{},"source":"User","matchWeight":100},"www.test.com":{"config":{"preventSaveNotification":true},"source":"User","matchWeight":100}},"pageExact":{},"pagePrefix":{"www.google.com":{"config":{"preventSaveNotification":false},"source":"User","matchWeight":100}},"hostRegex":{},"hostPrefix":{},"domainExact":{"fsdhfgdbfdgb":{"config":{"preventSaveNotification":false},"source":"User","matchWeight":100}}},"autoSubmitNetworkAuthWithSingleMatch":false,"notificationCountGeneric":3,"notificationCountSavePassword":10,"currentSearchTermTimeout":30,"animateWhenOfferingSave":true,"manualSubmitOverrideProhibited":false},"version":6}}}
//        """.trimIndent()
//        return temp
//        useMostRecentKey()

        keyId = prefs.getString(PREF_KEY_ID_PREFIX + label, null)
        keyId ?: throw Exception("Key not found. Save data before reading it please.")
        wrapper = SecretKeyWrapper("pm.kee.vault.$label.$keyId", accessRestrictions)
        val secretKey = getKey(wrapper)
        val plainBytes = decryptStorage(secretKey)
        plainBytes.let { return String(it, Charsets.UTF_8) }
        return null
    }
    fun setString(keyId: String, value: String) {
        wrapper = SecretKeyWrapper("pm.kee.vault.$label.$keyId", accessRestrictions)
        val secretKey = createKey(wrapper)
        val plainBytes = value.toByteArray(Charsets.UTF_8)
        encryptStorage(keyId, secretKey, plainBytes)
    }
    private fun decryptStorage(secretKey: SecretKey) : ByteArray {
        try {
            val str = prefs.getString(PREF_ENCRYPTED_STATE_PREFIX + label, null)
            val ba = str?.toByteArray(Charsets.ISO_8859_1)
            ba ?: throw Exception("Couldn't load state from shared prefs")
            return decryptBytes(ba, secretKey)
        } catch (e: Exception) {
            loge("Exception: $e")
            throw e
        }
    }
    private fun encryptStorage(id: String, secretKey: SecretKey, plainBytes: ByteArray) {
        val cipherBytes = plainBytes?.let { encryptBytes(it, secretKey) }
//        cipherBytes ?: return
        val str = String(cipherBytes, Charsets.ISO_8859_1)
        with (prefs.edit()) {
            putString(PREF_KEY_ID_PREFIX + label, id)
            putString("$PREF_ENCRYPTED_KEY_PREFIX$label.$keyId", String(wrapper.wrap(secretKey), Charsets.ISO_8859_1))
            putString(PREF_ENCRYPTED_STATE_PREFIX + label, str)
            commit()
        }
    }

}
